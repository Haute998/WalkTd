@{
    Layout = null;
    string menuid = ViewData["menuid"].ToString();
}

<!DOCTYPE html>

<html>
<head>
    <meta charset="utf-8">
    <title>素材列表</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <script src="~/js/layui-v1.0.3/layui/lay/dest/layui.all.js"></script>
    <link href="~/js/layui-v1.0.3/layui/css/layui.css" rel="stylesheet" media="all" />
    <script src="~/js/jquery-1.10.2.min.js"></script>
    <script src="~/js/jquery.tmpl.min.js"></script>
    <script src="~/js/common/Datehelper.js"></script>


    <link href="~/css/wxmp/base318f29.css" rel="stylesheet" />
    <link href="~/css/wxmp/lib318f29.css" rel="stylesheet" />
    <link href="~/css/wxmp/media_list2f12f7.css" rel="stylesheet" />
    <link href="~/css/wxmp/media2f624f.css" rel="stylesheet" />


</head>
<body>
    <div>
        <fieldset class="layui-elem-field layui-field-title" style="margin-top: 50px;">
            <legend>素材列表</legend>
        </fieldset>

        <div class="layui-tab layui-tab-card">
            <ul class="layui-tab-title">
                <li class="layui-this">图文</li>
                <li>图片</li>
            </ul>
            <div class="layui-tab-content">
                <div class="layui-tab-item layui-show">


                    <div class="main_bd" id="js_main">

                        <div class="main_bd" id="js_main">
                            <div class="sub_title_bar">
                                <div class="info">
                                    <h3 id="page_title">
                                        <span id="query_tips">图文消息</span>(共<span id="js_count">0</span>条)
                                    </h3>
                                    <div class="rank_style">
                                    </div>
                                </div>
                                <a target="_blank" class="btn btn_add btn_primary r btn_new" href="javascript:buliding()">
                                    <i class="icon14_common add_white"></i>新建图文消息
                                </a>
                            </div>


                            <div class="appmsg_list" id="datahtml" style="">
                            </div>
                            <div class="appmsg_list_v" id="js_list" style="display:none;"></div>

                            <div class="empty_tips dn" id="js_empty"><p>暂无素材</p></div>    <div class="empty_tips dn" id="js_search_empty">没有更多了</div>


                        </div>
                    </div>
                    <p style="text-align:center" id="moresucai" onclick="loadmore()" class="dn"><button class="layui-btn">更多</button></p>

                </div>
                <div class="layui-tab-item">
                    图片敬请期待，您可以选择图文
                </div>
            </div>
        </div>
    </div>
</body>
</html>
<script>
    layui.use('element', function () {
        var $ = layui.jquery
        , element = layui.element(); //Tab的切换功能，切换事件监听等，需要依赖element模块

    });
</script>
<script type="text/x-jquery-tmpl" id="datajs">
    {{each(i,ck) item}}
    <div class="appmsg_col tj_item">
        <div class="inner">
            <div class="js_appmsgitem">
                <div class="appmsg has_first_cover ${ck.content.news_item.length>1?" multi":"single"}" data-id="100000020" data-fileid="100000012" data-completed="1">
                    <div class="appmsg_content">
                        <div class="appmsg_info">
                            <em class="appmsg_date">${convertTenTime(ck.update_time).Format("yyyy-MM-dd hh:mm:ss")}</em>

                        </div>
                        {{each(j,newsitem) ck.content.news_item}}




                        {{if ck.content.news_item.length>1}}

                        {{if j==0}}
                        <div class="cover_appmsg_item">
                            <h4 class="appmsg_title js_title">

                                <a href="" target="_blank" data-msgid="100000020" data-idx="0">${newsitem.title}</a>

                            </h4>

                            <div class="appmsg_thumb_wrp" style="background-image: url('${newsitem.bo_url}')">
                                <!--

                                -->
                            </div>
                            <a href="javascript:void(0)" onclick="newshow('${newsitem.url}')" class="edit_mask preview_mask js_preview" data-msgid="100000020" data-idx="0">
                                <div class="edit_mask_content">
                                    <p class="">
                                        预览文章
                                    </p>
                                </div>
                                <span class="vm_box"></span>
                            </a>

                        </div>
                        {{else}}
                        <div class="appmsg_item ${ck.content.news_item.length==1?" has_cover":""}">



                            <div class="appmsg_thumb_wrp" style="background-image: url('${newsitem.bo_url}');">
                                <!--

                                -->
                            </div>
                            <h4 class="appmsg_title js_title">

                                <a href="" target="_blank" data-msgid="100000020" data-idx="1">${newsitem.title}</a>

                            </h4>

                            <a href="javascript:void(0)" onclick="newshow('${newsitem.url}')" class="edit_mask preview_mask js_preview" data-msgid="100000020" data-idx="1">
                                <div class="edit_mask_content">
                                    <p class="">
                                        预览文章
                                    </p>
                                </div>
                                <span class="vm_box"></span>
                            </a>

                        </div>

                        {{/if}}




                        {{else}}

                        <div class="appmsg_item">
                            <h4 class="appmsg_title js_title">

                                <a href="" target="_blank" data-msgid="100000018" data-idx="0">${newsitem.title}</a>

                            </h4>
                            <div class="appmsg_thumb_wrp" style="background-image: url('${newsitem.bo_url}')">
                            </div>
                            <p class="appmsg_desc"> ${newsitem.digest}</p>

                            <a href="javascript:void(0)" onclick="newshow('${newsitem.url}')" class="edit_mask preview_mask js_preview" data-msgid="100000018" data-idx="0">
                                <div class="edit_mask_content">
                                    <p class="">
                                        预览文章
                                    </p>
                                </div>
                                <span class="vm_box"></span>
                            </a>

                        </div>

                        {{/if}}




                        {{/each}}

                    </div>


                    <div class="appmsg_opr">
                        <ul>
                            <li class="appmsg_opr_item grid_item size1of2 no_extra">
                                <button class="layui-btn" onclick="go(this)" data-mediaid="${ck.media_id}" data-mediatype="news">选择</button>
                            </li>
                        </ul>
                    </div>


                </div>
            </div>
        </div>
    </div>
    {{/each}}
</script>
<script>
    var offset = 0;
    $(function () {
        getnewsdata();
    })


    function getnewsdata() {
        $.getJSON("/wxMaterial/getnews", { "offset": offset, "count": 10 }, function (data) {
            $("#datajs").tmpl(data).appendTo('#datahtml');
            $("#js_count").text(data.total_count);
            if (data.total_count == 0) {
                $("#js_empty").removeClass("dn");
            }
            else if (data.total_count > data.item_count) {
                $("#moresucai").removeClass("dn");
            }
            else if (data.item_count == 0) {
                $("#js_search_empty").removeClass("dn");
            }
        })
    }


    function loadmore() {
        offset++;
        getnewsdata();
    }


    function newshow(url) {
        layer.open({
            type: 2,
            title: "公众号图文素材预览",
            area: ['500px', '700px'],
            fixed: false, //不固定
            maxmin: true,
            content: url
        });
    }

    function buliding() {
        layer.alert("敬请期待");
    }


    function go(obj) {
        var mediaid = $(obj).attr("data-mediaid");
        var menuid = "@(menuid)";
        var mediatype = $(obj).attr("data-mediatype");

        $.post("/WxMenu/EditMedia", { "menuid": menuid, "Media_id": mediaid, "MediaType": mediatype }, function (rtn) {
            if (rtn == "ok") {

                parent.getmedia(mediatype, mediaid,menuid);
                var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
                parent.layer.close(index); //再执行关闭  

            }
            else
            {
                layer.alert(rtn);
            }
        })

    }
</script>